<!doctype html>
<html>
<style>
    div,
    fieldset,
    input,
    select {
        padding: 5px;
        font-size: 1em;
    }

    fieldset {
        background: #4f4f4f;
    }

    p {
        margin: 0.5em 0;
    }

    input {
        width: 100%;
        box-sizing: border-box;
        -webkit-box-sizing: border-box;
        -moz-box-sizing: border-box;
        background: #dddddd;
        color: #000000;
    }

    input[type=checkbox],
    input[type=radio] {
        width: 1em;
        margin-right: 6px;
        vertical-align: -1px;
    }

    input[type=range] {
        width: 99%;
    }

    select {
        width: 100%;
        background: #dddddd;
        color: #000000;
    }

    textarea {
        resize: none;
        width: 98%;
        height: 318px;
        padding: 5px;
        overflow: auto;
        background: #1f1f1f;
        color: #65c115;
    }

    body {
        text-align: center;
        font-family: verdana, sans-serif;
        background: #252525;
    }

    td {
        padding: 0px;
    }

    button {
        border: 0;
        border-radius: 0.3rem;
        background: #1fa3ec;
        color: #faffff;
        line-height: 2.4rem;
        font-size: 1.2rem;
        width: 100%;
        -webkit-transition-duration: 0.4s;
        transition-duration: 0.4s;
        cursor: pointer;
    }

    button:hover {
        background: #0e70a4;
    }

    .bred {
        background: #d43535;
    }

    .bred:hover {
        background: #931f1f;
    }

    .bgrn {
        background: #47c266;
    }

    .bgrn:hover {
        background: #5aaf6f;
    }

    a {
        color: #1fa3ec;
        text-decoration: none;
    }

    .p {
        float: left;
        text-align: left;
    }

    .q {
        float: right;
        text-align: right;
    }

    .r {
        border-radius: 0.3em;
        padding: 2px;
        margin: 6px 2px;
    }
</style>



<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ESP32-EBTKS</title>
    <style>
        #tdisplay.green {
            background-color: black;
            color: white;
        }

        #tdisplay {
            font-family: "5x7_dot_matrixregular", courier, monospace;
            font-size: 20px;
            white-space: pre;
            width: 768px;
            padding: 4px;

        }

        #tdisplay div span.cursor {
            color: white;
            background-color: black;
        }

        #tdisplay.green div span.cursor {
            color: black;
            background-color: white;
        }
    </style>
</head>


<body>
    <div style='text-align:center;color:#eaeaea;'>
        <noscript>
            To use EBTKS, please enable JavaScript
            <br>
        </noscript>
        <h3>EBTKS</h3>
    </div>

    <div id="tv">
        <canvas id="screen" width="512" height="384"></canvas>
    </div>
    <div style='text-align:left;display:inline-block;color:#eaeaea;min-width:340px;'>
        <p>
            <button type="button" onclick="document.location='updater'">Firmware Updater</button>
        </p>
        <p>
            <button type="button" onclick="fileStart()">File Transfer</button>
        </p>
    </div>

    <script>
        var ws;
        var fileText;
        // screen pixel dimensions (times 2 as each virtual pixel is 2,2)
        var numHpix = 512;
        var numVpix = 384;
        var isHP87 = false;

        function fileStart() {
            ws.send('{"open":{"path":"config.txt"}}\r\n');
        }

        function download(filename, text) {
            var pom = document.createElement('a');
            pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            pom.setAttribute('download', filename);

            if (document.createEvent) {
                var event = document.createEvent('MouseEvents');
                event.initEvent('click', true, true);
                pom.dispatchEvent(event);
            }
            else {
                pom.click();
            }
        }

        // This is called when the page finishes loading
        function init() {
            var gateway = `ws://${window.location.hostname}/ws`;
            //var ws = new WebSocket('ws://' + location.host + ':1337/');
            //var ws = new WebSocket('ws://192.168.1.136:1337/');
            //var ws = new WebSocket('ws://124.148.239.1:8000/ws');
            ws = new WebSocket(gateway);

            ws.onopen = function (ev) {
                console.log("Websocket connected");
                ws.send('{"get_alpha":{}}\r\n');
            }

            ws.onerror = function (ev) {
                console.log("Websocket event" + ev.data);
            }


            ws.onmessage = function (ev) {
                var obj = JSON.parse(ev.data);
                //process message
                var keys = Object.keys(obj);
                switch (keys[0]) {

                    case 'hpText':
                        var screenText = atob(obj["hpText"].image);
                        if (isHP87 != obj["hpText"].isHP87) {
                            //change video resolution
                            isHP87 = obj["hpText"].isHP87
                            if (isHP87 == true) {
                                numHpix = 1280;
                                numVpix = 576;
                                document.getElementById("screen").innerHTML = '<canvas id="screen" width="1280" height="576"></canvas>';
                            }
                            else {
                                numHpix = 512;
                                numVpix = 384;
                                document.getElementById("screen").innerHTML = '<canvas id="screen" width="512" height="384"></canvas>';
                            }
                        }

                        charmap(screenText);

                        //copy the string to the text buffer for the screen 32x16
                        /* for (var y = 0; y < 16; y++) {
                            for (var x = 0; x < 32; x++) {
                                var ch = screenText.charAt((y * 32) + x);
                                if ((ch.charCodeAt(0) < 0x20) || (ch.charCodeAt(0) > 0x7f)) {
                                    ch = " ";
                                }
                                func_t(y, x, ch);
                            }
                        } */
                        break;

                    case 'open':
                        var fd = parseInt(obj['open'.fd]);
                        console.log('FileDesc:', readLen);
                        fileText = "";
                        ws.send('{"read":{"fd":1,"len":100}}\r\n');
                        break;

                    case 'read':
                        var readData = atob(obj["read"].data);
                        var readLen = parseInt(obj['read'].len);
                        console.log('Length:', readLen);
                        if (readLen <= 0) {
                            ws.send('{"close":{"fd":1}}\r\n');
                        }
                        else {
                            fileText = fileText + readData;
                            ws.send('{"read":{"fd":1,"len":100}}\r\n');
                        }
                        break;

                    case 'write':
                        break;

                    case 'close':
                        console.log("File closed\r\n");
                        console.log(fileText);
                        download('config.txt', fileText);
                        break;

                }
                ws.send('{"get_alpha":{}}\r\n'); //simple ack to do flow control
            }


        }

        // Call the init function as soon as the page loads
        window.addEventListener("load", init, false);

        var screen = document.getElementById("screen");
        var canvas = document.getElementById("canvas");
        var ctx = screen.getContext("2d");
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, numHpix, numVpix);

        var imageData = ctx.getImageData(0, 0, numHpix, numVpix);

        function updateScreen(pos, val) {

            var pixPerByte = 8;
            var hPixSize = 2;
            var vPixSize = 2;
            var charPerLine = numHpix / 16;

            var screenX = (pos % charPerLine) * hPixSize * pixPerByte;
            var screenY = (pos - pos % charPerLine) / charPerLine * vPixSize;

            var tval = val & 0xff;

            for (var i = 0; i < pixPerByte; i++) {

                var color = tval & 0x80 ? [255, 255, 255] : [0, 0, 0];

                tval <<= 1;
                for (var x = 0; x < hPixSize; x++) {
                    for (var y = 0; y < vPixSize; y++) {
                        var idx0 = ((screenY + y) * numHpix + screenX + x + i * hPixSize) * 4;
                        imageData.data[idx0] = color[0];
                        imageData.data[idx0 + 1] = color[1];
                        imageData.data[idx0 + 2] = color[2];
                    }
                }
            }

        }

        //
        //  draw a character onto the screen
        //
        function drawChar(row, col, ch) {
            for (var sub_row = 0; sub_row < 12; sub_row++) {
                var pixels;
                var charPerLine = numHpix / 16;
                if (sub_row < 8) {
                    var cindex = (ch & 0x7f) * 8 + sub_row;
                    pixels = HP85chargen[cindex];
                } else if ((ch & 0x80) && (sub_row == 9 || sub_row == 10)) {
                    // Underline
                    pixels = 0xfe;
                } else {
                    pixels = 0;
                }
                updateScreen(((row + sub_row) * charPerLine) + (col / 8), pixels);
            }
        }

        function charmap(vram) {

            var video_start = 0;
            var num_rows = numVpix / 2;
            var num_cols = numHpix / 2;

            for (var row = 0; row < num_rows; row += 12) {

                for (var col = 0; col < num_cols; col += 8) {
                    var ch = vram.charCodeAt(video_start);
                    video_start += 1;
                    drawChar(row, col, ch, 32);
                }
            }
            ctx.putImageData(imageData, 0, 0); //updates the screen
        }
        var HP85chargen = [
            0x00, 0x04, 0x0c, 0x1c, 0x3c, 0x1c, 0x0c, 0x04, 0x00, 0x10, 0x00, 0x10, 0x20, 0x44, 0x44, 0x38,
            0x00, 0x7c, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x7c, 0x00, 0x44, 0x64, 0x54, 0x4c, 0x44,
            0x00, 0x00, 0x00, 0x34, 0x48, 0x48, 0x48, 0x34, 0x00, 0x00, 0x38, 0x44, 0x78, 0x44, 0x64, 0x58,
            0x00, 0x7c, 0x44, 0x40, 0x40, 0x40, 0x40, 0x40, 0x00, 0x7c, 0x00, 0x58, 0x64, 0x44, 0x44, 0x44,
            0x00, 0x00, 0x10, 0x10, 0x28, 0x28, 0x44, 0x7c, 0x00, 0x00, 0x00, 0x3c, 0x48, 0x48, 0x48, 0x30,
            0x00, 0x10, 0x38, 0x54, 0x10, 0x10, 0x10, 0x10, 0x00, 0x40, 0x20, 0x10, 0x28, 0x44, 0x44, 0x44,
            0x00, 0x00, 0x00, 0x24, 0x24, 0x24, 0x38, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x04, 0x38, 0x50, 0x10, 0x10, 0x10, 0x00, 0x38, 0x10, 0x38, 0x54, 0x38, 0x10, 0x38,
            0x00, 0x38, 0x44, 0x44, 0x7c, 0x44, 0x44, 0x38, 0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x28, 0x6c,
            0x00, 0x18, 0x20, 0x10, 0x38, 0x44, 0x44, 0x38, 0x00, 0x10, 0x38, 0x44, 0x44, 0x7c, 0x44, 0x44,
            0x00, 0x10, 0x00, 0x38, 0x48, 0x48, 0x48, 0x34, 0x00, 0x28, 0x38, 0x44, 0x44, 0x7c, 0x44, 0x44,
            0x00, 0x28, 0x00, 0x38, 0x48, 0x48, 0x48, 0x34, 0x00, 0x28, 0x38, 0x44, 0x44, 0x44, 0x44, 0x38,
            0x00, 0x28, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x28, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38,
            0x00, 0x28, 0x00, 0x44, 0x44, 0x44, 0x44, 0x3c, 0x00, 0x3c, 0x50, 0x50, 0x78, 0x50, 0x50, 0x5c,
            0x00, 0x00, 0x00, 0x28, 0x54, 0x58, 0x50, 0x2c, 0x00, 0x30, 0x48, 0x10, 0x20, 0x78, 0x00, 0x00,
            0x00, 0x18, 0x24, 0x20, 0x70, 0x20, 0x20, 0x7c, 0x00, 0x54, 0x28, 0x54, 0x28, 0x54, 0x28, 0x54,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10,
            0x00, 0x28, 0x28, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x28, 0x7c, 0x28, 0x7c, 0x28, 0x28,
            0x00, 0x10, 0x3c, 0x50, 0x38, 0x14, 0x78, 0x10, 0x00, 0x60, 0x64, 0x08, 0x10, 0x20, 0x4c, 0x0c,
            0x00, 0x20, 0x50, 0x50, 0x20, 0x54, 0x48, 0x34, 0x00, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x08, 0x10, 0x20, 0x20, 0x20, 0x10, 0x08, 0x00, 0x20, 0x10, 0x08, 0x08, 0x08, 0x10, 0x20,
            0x00, 0x10, 0x54, 0x38, 0x10, 0x38, 0x54, 0x10, 0x00, 0x00, 0x10, 0x10, 0x7c, 0x10, 0x10, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x10, 0x20, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00,
            0x00, 0x38, 0x44, 0x4c, 0x54, 0x64, 0x44, 0x38, 0x00, 0x10, 0x30, 0x10, 0x10, 0x10, 0x10, 0x38,
            0x00, 0x38, 0x44, 0x04, 0x18, 0x20, 0x40, 0x7c, 0x00, 0x7c, 0x04, 0x08, 0x18, 0x04, 0x44, 0x38,
            0x00, 0x08, 0x18, 0x28, 0x48, 0x7c, 0x08, 0x08, 0x00, 0x7c, 0x40, 0x78, 0x04, 0x04, 0x44, 0x38,
            0x00, 0x1c, 0x20, 0x40, 0x78, 0x44, 0x44, 0x38, 0x00, 0x7c, 0x04, 0x08, 0x10, 0x20, 0x20, 0x20,
            0x00, 0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x38, 0x00, 0x38, 0x44, 0x44, 0x3c, 0x04, 0x08, 0x70,
            0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x10, 0x10, 0x20,
            0x00, 0x04, 0x08, 0x10, 0x20, 0x10, 0x08, 0x04, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x7c, 0x00, 0x00,
            0x00, 0x40, 0x20, 0x10, 0x08, 0x10, 0x20, 0x40, 0x00, 0x38, 0x44, 0x44, 0x08, 0x10, 0x00, 0x10,
            0x00, 0x38, 0x44, 0x54, 0x5c, 0x58, 0x40, 0x3c, 0x00, 0x38, 0x44, 0x44, 0x7c, 0x44, 0x44, 0x44,
            0x00, 0x78, 0x44, 0x44, 0x78, 0x44, 0x44, 0x78, 0x00, 0x38, 0x44, 0x40, 0x40, 0x40, 0x44, 0x38,
            0x00, 0x78, 0x44, 0x44, 0x44, 0x44, 0x44, 0x78, 0x00, 0x7c, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7c,
            0x00, 0x7c, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x00, 0x3c, 0x40, 0x40, 0x40, 0x4c, 0x44, 0x3c,
            0x00, 0x44, 0x44, 0x44, 0x7c, 0x44, 0x44, 0x44, 0x00, 0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38,
            0x00, 0x04, 0x04, 0x04, 0x04, 0x04, 0x44, 0x38, 0x00, 0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44,
            0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7c, 0x00, 0x44, 0x6c, 0x54, 0x54, 0x44, 0x44, 0x44,
            0x00, 0x44, 0x44, 0x64, 0x54, 0x4c, 0x44, 0x44, 0x00, 0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38,
            0x00, 0x78, 0x44, 0x44, 0x78, 0x40, 0x40, 0x40, 0x00, 0x38, 0x44, 0x44, 0x44, 0x54, 0x48, 0x34,
            0x00, 0x78, 0x44, 0x44, 0x78, 0x50, 0x48, 0x44, 0x00, 0x38, 0x44, 0x40, 0x38, 0x04, 0x44, 0x38,
            0x00, 0x7c, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38,
            0x00, 0x44, 0x44, 0x44, 0x44, 0x28, 0x28, 0x10, 0x00, 0x44, 0x44, 0x44, 0x54, 0x54, 0x6c, 0x44,
            0x00, 0x44, 0x44, 0x28, 0x10, 0x28, 0x44, 0x44, 0x00, 0x44, 0x44, 0x28, 0x10, 0x10, 0x10, 0x10,
            0x00, 0x7c, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7c, 0x00, 0x7c, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7c,
            0x00, 0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x00, 0x00, 0x7c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x7c,
            0x00, 0x00, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c,
            0x00, 0x20, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x38, 0x04, 0x3c, 0x44, 0x3c,
            0x00, 0x40, 0x40, 0x58, 0x64, 0x44, 0x44, 0x78, 0x00, 0x00, 0x00, 0x3c, 0x40, 0x40, 0x40, 0x3c,
            0x00, 0x04, 0x04, 0x34, 0x4c, 0x44, 0x44, 0x3c, 0x00, 0x00, 0x00, 0x38, 0x44, 0x7c, 0x40, 0x38,
            0x00, 0x08, 0x10, 0x10, 0x38, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x3c, 0x44, 0x3c, 0x04, 0x18,
            0x00, 0x40, 0x40, 0x58, 0x64, 0x44, 0x44, 0x44, 0x00, 0x10, 0x00, 0x30, 0x10, 0x10, 0x10, 0x38,
            0x00, 0x08, 0x00, 0x18, 0x08, 0x08, 0x48, 0x30, 0x00, 0x20, 0x20, 0x24, 0x28, 0x30, 0x28, 0x24,
            0x00, 0x30, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00, 0x68, 0x54, 0x54, 0x54, 0x54,
            0x00, 0x00, 0x00, 0x58, 0x64, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38,
            0x00, 0x00, 0x00, 0x78, 0x44, 0x78, 0x40, 0x40, 0x00, 0x00, 0x00, 0x38, 0x48, 0x38, 0x08, 0x0c,
            0x00, 0x00, 0x00, 0x2c, 0x30, 0x20, 0x20, 0x20, 0x00, 0x00, 0x00, 0x3c, 0x40, 0x38, 0x04, 0x78,
            0x00, 0x00, 0x10, 0x38, 0x10, 0x10, 0x10, 0x08, 0x00, 0x00, 0x00, 0x44, 0x44, 0x44, 0x4c, 0x34,
            0x00, 0x00, 0x00, 0x44, 0x44, 0x28, 0x28, 0x10, 0x00, 0x00, 0x00, 0x44, 0x44, 0x54, 0x54, 0x28,
            0x00, 0x00, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x44, 0x28, 0x10, 0x20, 0x40,
            0x00, 0x00, 0x00, 0x7c, 0x08, 0x10, 0x20, 0x7c, 0x00, 0x00, 0x04, 0x38, 0x68, 0x28, 0x28, 0x28,
            0x00, 0x10, 0x10, 0x10, 0x00, 0x10, 0x10, 0x10, 0x00, 0x00, 0x10, 0x08, 0x7c, 0x08, 0x10, 0x00,
            0x00, 0x7c, 0x24, 0x10, 0x08, 0x10, 0x24, 0x7c, 0x00, 0x40, 0x40, 0x40, 0x7c, 0x40, 0x40, 0x40
        ];


    </script>
</body>

</html>